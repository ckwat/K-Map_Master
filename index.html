<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- SEO Meta Tags -->
    <title>K-Map Master: Interactive Karnaugh Map & Logic Simplification Game</title>
    <meta name="description"
        content="Master logic simplification and Boolean algebra with K-Map Master, an interactive game featuring Karnaugh Maps, Quine-McCluskey solver hints, and custom practice drills (2, 3, 4 variables)." />
    <meta name="keywords"
        content="K-Map, Karnaugh Map, Logic Simplification, Boolean Algebra, Digital Logic, Quine-McCluskey, K-Map Game, Digital Electronics, Truth Table" />
    <meta name="author" content="Kelvin WAT" />
    <link rel="canonical" href="https://ckwat.github.io/K-Map_Master/" />
    <link rel="icon" type="image/png" href="./icon_k-map.png">
    <link rel="apple-touch-icon" href="./icon_k-map.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./icon_k-map.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;800&family=Noto+Sans+TC:wght@400;700&display=swap');

        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
        }

        .mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e293b;
        }

        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        .cell {
            transition: all 0.2s ease;
        }

        /* Hover effects only on devices that support hover (not mobile) */
        @media (hover: hover) {
            .cell:hover {
                filter: brightness(1.2);
            }
        }

        .kmap-grid {
            display: grid;
            gap: 2px;
            background-color: #334155;
            border: 2px solid #475569;
            border-radius: 8px;
            overflow: hidden;
        }

        /* Animation for success */
        @keyframes success-pop {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        .animate-success {
            animation: success-pop 0.3s ease-in-out;
        }
    </style>
</head>

<body class="h-screen supports-[height:100dvh]:h-[100dvh] flex flex-col overflow-hidden">

    <!-- Header -->
    <header
        class="bg-slate-800 border-b border-slate-700 p-3 md:p-4 flex justify-between items-center shadow-md z-10 shrink-0">
        <div class="flex items-center gap-3">
            <div class="bg-indigo-500 text-white p-2 rounded-lg">
                <i class="fas fa-microchip text-lg md:text-xl"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg md:text-xl tracking-tight text-white" data-i18n="appTitle">K-Map Master
                </h1>
                <p class="text-[10px] md:text-xs text-slate-400" id="stage-indicator" data-i18n="menuSubtitle">Main Menu
                </p>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <!-- Language Selector -->
            <select id="lang-selector" onchange="app.setLanguage(this.value)"
                class="bg-slate-700 text-white text-xs md:text-sm rounded px-2 py-1 border border-slate-600 focus:outline-none focus:border-indigo-500">
                <option value="en">English</option>
                <option value="zh">繁體中文</option>
            </select>
            <button onclick="app.showSettings()" class="p-2 text-slate-400 hover:text-white transition"><i
                    class="fas fa-cog"></i></button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-1 relative overflow-hidden flex justify-center items-center bg-slate-900">

        <!-- View: Main Menu -->
        <div id="view-menu"
            class="text-center max-w-md w-full p-6 space-y-8 animate-fade-in overflow-y-auto max-h-full">
            <div class="space-y-2">
                <h2 class="text-3xl md:text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-cyan-400"
                    data-i18n="heroTitle">Logic Simplified</h2>
                <p class="text-slate-400 text-sm md:text-base" data-i18n="heroDesc">Master Boolean Algebra optimization
                    through interactive visualization.</p>
            </div>

            <div class="grid gap-4">
                <button onclick="app.startCampaign()"
                    class="group relative w-full py-4 px-6 bg-indigo-600 hover:bg-indigo-500 rounded-xl font-bold text-white shadow-lg shadow-indigo-900/50 transition-all hover:-translate-y-1">
                    <div class="flex items-center justify-between">
                        <span><i class="fas fa-play mr-2"></i> <span data-i18n="btnCampaign">Campaign Mode</span></span>
                        <span class="text-xs bg-indigo-800 px-2 py-1 rounded text-indigo-200 group-hover:bg-indigo-700"
                            data-i18n="tagStages">Stage 1-3</span>
                    </div>
                </button>

                <button onclick="app.startCustomSetup()"
                    class="w-full py-4 px-6 bg-slate-800 hover:bg-slate-700 border border-slate-700 hover:border-slate-600 rounded-xl font-bold text-slate-200 transition-all">
                    <i class="fas fa-tools mr-2"></i> <span data-i18n="btnPractice">Practice Mode</span>
                </button>
            </div>
        </div>

        <!-- View: Custom Setup -->
        <div id="view-setup"
            class="hidden max-w-md w-full bg-slate-800 p-6 rounded-2xl shadow-2xl border border-slate-700">
            <h2 class="text-2xl font-bold mb-6 text-white"><i class="fas fa-sliders-h mr-2"></i><span
                    data-i18n="configTitle">Configuration</span></h2>

            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-slate-400 mb-2" data-i18n="lblVars">Number of
                        Variables</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="app.setSetupVar(2)"
                            class="setup-var-btn py-2 rounded bg-slate-700 hover:bg-indigo-600 transition"
                            data-val="2">2 Vars</button>
                        <button onclick="app.setSetupVar(3)"
                            class="setup-var-btn py-2 rounded bg-slate-700 hover:bg-indigo-600 transition"
                            data-val="3">3 Vars</button>
                        <button onclick="app.setSetupVar(4)"
                            class="setup-var-btn py-2 rounded bg-slate-700 hover:bg-indigo-600 transition"
                            data-val="4">4 Vars</button>
                    </div>
                </div>

                <div class="flex items-center justify-between p-3 bg-slate-700/50 rounded-lg">
                    <label class="text-sm font-medium text-slate-300" data-i18n="lblDontCare">Allow Don't Cares
                        (X)</label>
                    <input type="checkbox" id="setup-dontcare" class="w-5 h-5 rounded accent-indigo-500">
                </div>

                <div class="flex gap-3 pt-4">
                    <button onclick="app.showMenu()" class="flex-1 py-2 text-slate-400 hover:text-white"
                        data-i18n="btnBack">Back</button>
                    <button onclick="app.launchCustomGame()"
                        class="flex-1 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg font-bold"
                        data-i18n="btnStart">Start</button>
                </div>
            </div>
        </div>

        <!-- View: Game Board -->
        <div id="view-game" class="hidden w-full h-full flex flex-col md:flex-row overflow-hidden">

            <!-- Left: Game Area (Map) -->
            <div
                class="flex-1 flex flex-col items-center justify-center p-2 md:p-4 overflow-auto relative bg-slate-900">

                <!-- Game Info Bar -->
                <div
                    class="absolute top-2 left-2 right-2 md:top-4 md:left-4 md:right-4 flex justify-between items-start pointer-events-none z-20">
                    <div
                        class="pointer-events-auto bg-slate-800/90 backdrop-blur p-2 md:p-3 rounded-lg border border-slate-700 shadow-lg max-w-[60%]">
                        <div class="text-[10px] text-slate-400 uppercase tracking-wider hidden md:block"
                            data-i18n="lblObj">Objective</div>
                        <div class="font-medium text-xs md:text-sm text-indigo-200 leading-tight" data-i18n="txtObj">
                            Group <span class="text-emerald-400 font-bold">1</span>s. Avoid <span
                                class="text-rose-400 font-bold">0</span>s.</div>
                    </div>

                    <div class="pointer-events-auto flex gap-2">
                        <button onclick="app.toggleHint()"
                            class="bg-amber-500/10 text-amber-400 border border-amber-500/30 px-2 py-1 md:px-3 md:py-2 rounded hover:bg-amber-500/20 transition text-xs md:text-sm font-bold">
                            <i class="fas fa-lightbulb mr-1"></i> <span data-i18n="btnHint">Hint</span>
                        </button>
                    </div>
                </div>

                <!-- K-Map Container -->
                <div class="relative mt-8 md:mt-12 mb-4 md:mb-8 flex-shrink-0">
                    <div id="kmap-container"
                        class="relative p-3 md:p-8 bg-slate-800 rounded-xl shadow-2xl border border-slate-700">
                        <div class="absolute top-1 left-2 md:top-2 md:left-2 font-bold text-slate-500 mono text-[10px] md:text-sm"
                            id="map-vars">AB \ CD</div>
                        <div id="grid-root" class="kmap-grid relative z-0"></div>
                        <svg id="groups-layer"
                            class="absolute top-0 left-0 w-full h-full pointer-events-none z-10 overflow-visible"></svg>
                    </div>
                </div>

                <!-- Selection Controls -->
                <div
                    class="flex gap-2 md:gap-4 items-center bg-slate-800 p-2 rounded-lg border border-slate-700 shadow-lg z-20 mb-2">
                    <span class="text-[10px] md:text-xs text-slate-400 px-1 md:px-2"><span
                            data-i18n="lblSel">Sel:</span> <span id="selection-count"
                            class="font-bold text-white">0</span></span>
                    <button onclick="app.createGroup()"
                        class="bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-1.5 md:px-4 rounded text-xs md:text-sm font-bold transition disabled:opacity-50 disabled:cursor-not-allowed"
                        id="btn-add-group">
                        <i class="fas fa-plus mr-1"></i> <span data-i18n="btnAdd">Add</span>
                    </button>
                    <button onclick="app.clearSelection()" class="text-slate-400 hover:text-white px-2 text-sm">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

            </div>

            <!-- Right: Control Panel -->
            <div
                class="w-full md:w-80 h-[45vh] md:h-full bg-slate-800 border-t md:border-t-0 md:border-l border-slate-700 flex flex-col z-30 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] shrink-0">

                <!-- User Equation Input -->
                <div class="p-4 md:p-6 border-b border-slate-700 bg-slate-800/50">
                    <label class="block text-[10px] md:text-xs font-bold text-slate-400 uppercase mb-2"
                        data-i18n="lblEq">Boolean Equation</label>
                    <div class="relative">
                        <input type="text" id="equation-input" placeholder="e.g. A'B + CD"
                            class="w-full bg-slate-900 border border-slate-600 rounded p-2 md:p-3 text-sm text-white mono focus:border-indigo-500 focus:outline-none placeholder-slate-600">
                    </div>
                    <p class="hidden md:block text-[10px] text-slate-500 mt-2" data-i18n="txtEqHelp">Use ' for NOT
                        (e.g., A'). + for OR.</p>
                </div>

                <!-- Groups List -->
                <div class="flex-1 overflow-y-auto p-3 md:p-4 min-h-0">
                    <h3 class="text-[10px] md:text-xs font-bold text-slate-400 uppercase mb-2 md:mb-3 sticky top-0 bg-slate-800 py-1"
                        data-i18n="lblActive">Active Groups</h3>
                    <div id="groups-list" class="space-y-2">
                        <div class="text-xs md:text-sm text-slate-500 italic text-center py-4" data-i18n="txtNoGroups">
                            No groups created yet.</div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="p-3 md:p-4 bg-slate-900 border-t border-slate-700 space-y-2 md:space-y-3 pb-6 md:pb-4">
                    <button onclick="app.checkSolution()"
                        class="w-full bg-indigo-600 hover:bg-indigo-500 text-white py-2 md:py-3 rounded-lg font-bold shadow-lg shadow-indigo-900/20 transition transform active:scale-95 text-sm md:text-base"
                        data-i18n="btnCheck">
                        CHECK SOLUTION
                    </button>

                    <button onclick="app.newProblem()"
                        class="w-full bg-emerald-600 hover:bg-emerald-500 text-emerald-50 py-2 rounded-lg font-bold shadow-lg transition text-xs md:text-sm">
                        <i class="fas fa-sync-alt mr-2"></i> <span data-i18n="btnNew">New Problem</span>
                    </button>

                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="app.restartLevel()"
                            class="bg-slate-700 hover:bg-slate-600 text-slate-200 py-2 rounded text-xs md:text-sm font-medium"
                            data-i18n="btnReset">Reset Board</button>
                        <button onclick="app.showAnswer()"
                            class="bg-slate-700 hover:bg-slate-600 text-rose-300 py-2 rounded text-xs md:text-sm font-medium"
                            data-i18n="btnGiveUp">Give Up</button>
                    </div>

                    <button onclick="app.showMenu()"
                        class="w-full text-[10px] md:text-xs text-slate-500 hover:text-slate-300 pt-1"
                        data-i18n="btnExit">Exit to Main Menu</button>
                </div>
            </div>
        </div>

    </main>

    <!-- Feedback Modal -->
    <div id="modal-feedback"
        class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center backdrop-blur-sm">
        <div
            class="bg-slate-800 border border-slate-600 rounded-2xl p-8 max-w-sm w-full text-center shadow-2xl transform transition-all scale-100">
            <div id="modal-icon" class="text-5xl mb-4"></div>
            <h3 id="modal-title" class="text-2xl font-bold text-white mb-2"></h3>
            <p id="modal-msg" class="text-slate-300 mb-6"></p>
            <button onclick="app.closeModal()" id="modal-btn"
                class="w-full py-3 rounded-lg font-bold text-white bg-indigo-600 hover:bg-indigo-500">Continue</button>
        </div>
    </div>

    <!-- JS LOGIC -->
    <script>
        /* --- TRANSLATIONS & I18N --- */
        const translations = {
            en: {
                appTitle: "K-Map Master",
                menuSubtitle: "Main Menu",
                heroTitle: "Logic Simplified",
                heroDesc: "Master Boolean Algebra optimization through interactive visualization.",
                btnCampaign: "Campaign Mode",
                tagStages: "Stage 1-3",
                btnPractice: "Practice Mode",
                configTitle: "Configuration",
                lblVars: "Number of Variables",
                lblDontCare: "Allow Don't Cares (X)",
                btnBack: "Back",
                btnStart: "Start",
                lblObj: "Objective",
                txtObj: 'Group all <span class="text-emerald-400 font-bold">1</span>s. Avoid <span class="text-rose-400 font-bold">0</span>s.',
                btnHint: "Hint",
                lblSel: "Sel:",
                btnAdd: "Add",
                lblEq: "Boolean Equation",
                txtEqHelp: "Use ' for NOT (e.g., A'). + for OR.",
                lblActive: "Active Groups",
                txtNoGroups: "No groups created yet.",
                btnCheck: "CHECK SOLUTION",
                btnNew: "New Problem",
                btnReset: "Reset Board",
                btnGiveUp: "Give Up",
                btnExit: "Exit to Main Menu",
                // Dynamic
                stageCampaign: "Campaign - Stage",
                modePractice: "Practice Mode",
                groupLabel: "Group",
                cells: "cells",
                // Modals
                mInvalidGroup: "Invalid Group",
                mInvalidGroupMsg: "Selection must be a power of 2 (1, 2, 4, 8...) and form a rectangular block (including wraps).",
                mInvalidContent: "Invalid Content",
                mInvalidContentMsg: "Groups cannot contain '0' cells.",
                mHintTitle: "Hint",
                mHintMsgTarget: "Focus on the cell at index {i} (Binary: {b}). It needs to be grouped.",
                mHintMsgCovered: "All 1s are covered. Check if you have groups fully contained inside other groups, or if you can make groups larger.",
                mSolvedTitle: "Solved",
                mSolvedMsg: "Here is the optimal grouping. Study the pattern!",
                mIncompleteTitle: "Incomplete",
                mIncompleteMsg: "There are still 1s remaining on the map.",
                mNotOptimalTitle: "Not Optimal",
                mNotOptimalMsg: "You have {u} groups, but this can be solved with {o}. Look for larger patterns or redundant groups.",
                mSuccessTitle: "Success!",
                mSuccessMsg: "Great job! You've simplified the map correctly.",
                btnNextStage: "Next Stage",
                btnContinue: "Continue"
            },
            zh: {
                appTitle: "K-Map 大師",
                menuSubtitle: "主選單",
                heroTitle: "邏輯簡化",
                heroDesc: "透過互動視覺化掌握布林代數優化。",
                btnCampaign: "闖關模式",
                tagStages: "第 1-3 關",
                btnPractice: "練習模式",
                configTitle: "設定",
                lblVars: "變數數量",
                lblDontCare: "允許隨意項 (Don't Cares)",
                btnBack: "返回",
                btnStart: "開始",
                lblObj: "目標",
                txtObj: '圈選所有 <span class="text-emerald-400 font-bold">1</span>，避開 <span class="text-rose-400 font-bold">0</span>。',
                btnHint: "提示",
                lblSel: "已選:",
                btnAdd: "新增",
                lblEq: "布林方程式",
                txtEqHelp: "用 ' 代表反相 (如 A')，+ 代表 OR。",
                lblActive: "目前群組",
                txtNoGroups: "尚未建立群組。",
                btnCheck: "檢查答案",
                btnNew: "新題目",
                btnReset: "重置版面",
                btnGiveUp: "顯示答案",
                btnExit: "回到主選單",
                // Dynamic
                stageCampaign: "闖關模式 - 第",
                modePractice: "練習模式",
                groupLabel: "群組",
                cells: "格",
                // Modals
                mInvalidGroup: "群組無效",
                mInvalidGroupMsg: "選取數量必須是 2 的次方 (1, 2, 4, 8...) 且為矩形區塊 (包含跨邊界)。",
                mInvalidContent: "內容無效",
                mInvalidContentMsg: "群組不能包含 '0'。",
                mHintTitle: "提示",
                mHintMsgTarget: "注意索引為 {i} 的方格 (二進位: {b})。它需要被分組。",
                mHintMsgCovered: "所有的 1 都已覆蓋。檢查是否有被其他群組包含的冗餘群組，或嘗試擴大群組。",
                mSolvedTitle: "已解答",
                mSolvedMsg: "這是最佳的分組方式。請觀察其中的規律！",
                mIncompleteTitle: "未完成",
                mIncompleteMsg: "地圖上還有未圈選的 1。",
                mNotOptimalTitle: "非最佳解",
                mNotOptimalMsg: "你用了 {u} 個群組，但這可以用 {o} 個群組解決。請尋找更大的樣式或移除多餘群組。",
                mSuccessTitle: "成功！",
                mSuccessMsg: "太棒了！你已正確簡化地圖。",
                btnNextStage: "下一關",
                btnContinue: "繼續"
            }
        };

        /* --- LOGIC ENGINE: QUINE-MCCLUSKEY & UTILS --- */

        const Utils = {
            toBin: (num, vars) => num.toString(2).padStart(vars, '0'),

            grayCodes: {
                2: ['00', '01', '11', '10']
            },

            isValidGroup: (indices, numVars) => {
                if (![1, 2, 4, 8, 16].includes(indices.length)) return false;
                if (indices.length === 1) return true;

                const base = indices[0];
                let varyMask = 0;
                for (let i = 1; i < indices.length; i++) {
                    varyMask |= (base ^ indices[i]);
                }

                let varyingBits = 0;
                let temp = varyMask;
                while (temp) { varyingBits += temp & 1; temp >>= 1; }

                if (Math.pow(2, varyingBits) !== indices.length) return false;

                const constantMask = ~varyMask & ((1 << numVars) - 1);
                const constantValue = base & constantMask;

                for (let idx of indices) {
                    if ((idx & constantMask) !== constantValue) return false;
                }
                return true;
            }
        };

        class Solver {
            constructor(numVars, minterms, dontCares) {
                this.numVars = numVars;
                this.minterms = new Set(minterms);
                this.dontCares = new Set(dontCares);
            }

            solve() {
                let allTerms = [...this.minterms, ...this.dontCares];
                let groups = Array.from({ length: this.numVars + 1 }, () => []);
                allTerms.forEach(t => {
                    let bin = Utils.toBin(t, this.numVars);
                    let ones = bin.split('1').length - 1;
                    groups[ones].push({ bin: bin, indices: [t], checked: false });
                });

                let primeImplicants = [];
                let changed = true;
                while (changed) {
                    changed = false;
                    let nextGroups = Array.from({ length: this.numVars + 1 }, () => []);
                    for (let i = 0; i < groups.length - 1; i++) {
                        for (let t1 of groups[i]) {
                            for (let t2 of groups[i + 1]) {
                                let diff = this.getDifference(t1.bin, t2.bin);
                                if (diff.count === 1) {
                                    t1.checked = true;
                                    t2.checked = true;
                                    let newBin = t1.bin.substring(0, diff.index) + '-' + t1.bin.substring(diff.index + 1);
                                    let newIndices = [...t1.indices, ...t2.indices].sort((a, b) => a - b);
                                    if (!nextGroups[i].some(x => x.bin === newBin)) {
                                        nextGroups[i].push({ bin: newBin, indices: newIndices, checked: false });
                                        changed = true;
                                    }
                                }
                            }
                        }
                    }
                    groups.flat().forEach(t => {
                        if (!t.checked && !primeImplicants.some(p => p.bin === t.bin)) primeImplicants.push(t);
                    });
                    if (changed) groups = nextGroups;
                }
                groups.flat().forEach(t => {
                    if (!primeImplicants.some(p => p.bin === t.bin)) primeImplicants.push(t);
                });

                let remainingMinterms = [...this.minterms];
                let essentialPIs = [];

                primeImplicants.sort((a, b) => {
                    let dashesA = a.bin.split('-').length;
                    let dashesB = b.bin.split('-').length;
                    return dashesB - dashesA;
                });

                for (let pi of primeImplicants) {
                    let covers = pi.indices.filter(idx => remainingMinterms.includes(idx));
                    if (covers.length > 0) {
                        essentialPIs.push(pi);
                        remainingMinterms = remainingMinterms.filter(m => !covers.includes(m));
                    }
                }
                return essentialPIs;
            }

            getDifference(bin1, bin2) {
                let count = 0;
                let index = -1;
                for (let i = 0; i < bin1.length; i++) {
                    if (bin1[i] !== bin2[i]) { count++; index = i; }
                }
                return { count, index };
            }

            static binToTerm(bin, vars) {
                const names = ['A', 'B', 'C', 'D'];
                let term = "";
                for (let i = 0; i < vars; i++) {
                    if (bin[i] === '0') term += names[i] + "'";
                    if (bin[i] === '1') term += names[i];
                }
                return term || "1";
            }
        }

        /* --- APP LOGIC --- */

        const AppState = {
            lang: 'en',
            stage: 1,
            mode: 'menu',
            numVars: 2,
            useDontCares: false,
            minterms: new Set(),
            dontCares: new Set(),
            userGroups: [],
            selectedIndices: new Set(),
            colors: ['bg-red-500', 'bg-blue-500', 'bg-green-500', 'bg-yellow-500', 'bg-purple-500'],
            colorIndex: 0
        };

        const app = {
            init: () => {
                app.setLanguage('en');
                app.showMenu();
            },

            /* --- I18N --- */
            setLanguage: (lang) => {
                AppState.lang = lang;
                document.getElementById('lang-selector').value = lang;

                // Update static elements
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    if (translations[lang][key]) {
                        el.innerHTML = translations[lang][key];
                    }
                });

                // Refresh dynamic text
                app.updateStageIndicator();
                app.renderGroupsList(); // Refresh group list text
            },

            t: (key) => {
                return translations[AppState.lang][key] || key;
            },

            /* --- NAVIGATION --- */
            showMenu: () => {
                document.getElementById('view-menu').classList.remove('hidden');
                document.getElementById('view-setup').classList.add('hidden');
                document.getElementById('view-game').classList.add('hidden');
                app.updateStageIndicator("menuSubtitle");
            },

            showSettings: () => {
                alert("Settings: Sound (On).");
            },

            startCampaign: () => {
                AppState.mode = 'campaign';
                app.loadStage(1);
            },

            loadStage: (stage) => {
                AppState.stage = stage;
                AppState.userGroups = [];
                AppState.selectedIndices.clear();
                document.getElementById('equation-input').value = '';

                if (stage === 1) {
                    AppState.numVars = 2;
                    AppState.useDontCares = false;
                } else if (stage === 2) {
                    AppState.numVars = 3;
                    AppState.useDontCares = false;
                } else if (stage === 3) {
                    AppState.numVars = 4;
                    AppState.useDontCares = true;
                }

                app.generateLevel();
                app.startGameView();
                app.updateStageIndicator();
            },

            startCustomSetup: () => {
                document.getElementById('view-menu').classList.add('hidden');
                document.getElementById('view-setup').classList.remove('hidden');
                AppState.numVars = 2;
                app.updateSetupUI();
            },

            setSetupVar: (n) => {
                AppState.numVars = n;
                app.updateSetupUI();
            },

            updateSetupUI: () => {
                document.querySelectorAll('.setup-var-btn').forEach(btn => {
                    if (parseInt(btn.dataset.val) === AppState.numVars) {
                        btn.classList.add('bg-indigo-600', 'text-white');
                        btn.classList.remove('bg-slate-700');
                    } else {
                        btn.classList.remove('bg-indigo-600', 'text-white');
                        btn.classList.add('bg-slate-700');
                    }
                });
            },

            launchCustomGame: () => {
                AppState.mode = 'custom';
                AppState.useDontCares = document.getElementById('setup-dontcare').checked;
                AppState.userGroups = [];
                AppState.selectedIndices.clear();
                document.getElementById('equation-input').value = '';

                app.generateLevel();
                app.startGameView();
                app.updateStageIndicator();
            },

            startGameView: () => {
                document.getElementById('view-menu').classList.add('hidden');
                document.getElementById('view-setup').classList.add('hidden');
                document.getElementById('view-game').classList.remove('hidden');
                app.renderGrid();
                app.renderGroupsList();
            },

            updateStageIndicator: (forceKey) => {
                const el = document.getElementById('stage-indicator');
                if (forceKey) {
                    el.innerHTML = app.t(forceKey);
                    return;
                }
                if (AppState.mode === 'campaign') {
                    const prefix = app.t('stageCampaign');
                    el.innerHTML = prefix.endsWith('Stage') ? `${prefix} ${AppState.stage}` : `${prefix}${AppState.stage}關`;
                } else {
                    el.innerHTML = `${app.t('modePractice')} - ${AppState.numVars} Vars`;
                }
            },

            /* --- GAME LOGIC --- */
            newProblem: () => {
                app.generateLevel();
                app.restartLevel();
            },

            generateLevel: () => {
                const totalCells = Math.pow(2, AppState.numVars);
                AppState.minterms.clear();
                AppState.dontCares.clear();
                let filled = 0;
                for (let i = 0; i < totalCells; i++) {
                    const rand = Math.random();
                    if (rand > 0.6) {
                        AppState.minterms.add(i);
                    } else if (AppState.useDontCares && rand < 0.1) {
                        AppState.dontCares.add(i);
                    }
                }
                if (AppState.minterms.size === 0) AppState.minterms.add(0);
            },

            restartLevel: () => {
                AppState.userGroups = [];
                AppState.selectedIndices.clear();
                document.getElementById('equation-input').value = '';
                app.renderGrid();
                app.renderGroupsList();
                app.renderGroupsOverlay();
            },

            /* --- RENDERING --- */
            renderGrid: () => {
                const root = document.getElementById('grid-root');
                const mapVars = document.getElementById('map-vars');
                root.innerHTML = '';

                let cols = AppState.numVars === 2 ? 2 : 4;
                let rows = AppState.numVars === 4 ? 4 : 2;

                root.style.gridTemplateColumns = `repeat(${cols}, minmax(50px, 1fr))`;
                root.style.gridTemplateRows = `repeat(${rows}, minmax(50px, 1fr))`;

                if (AppState.numVars === 2) mapVars.innerText = "A \\ B";
                if (AppState.numVars === 3) mapVars.innerText = "A \\ BC";
                if (AppState.numVars === 4) mapVars.innerText = "AB \\ CD";

                const rowCodes = AppState.numVars === 4 ? Utils.grayCodes[2] : ['0', '1'];
                const colCodes = AppState.numVars === 2 ? ['0', '1'] : Utils.grayCodes[2];

                for (let r = 0; r < rows; r++) {
                    for (let c = 0; c < cols; c++) {
                        let rowBits = rowCodes[r];
                        let colBits = colCodes[c];
                        let binaryStr = rowBits + colBits;
                        let index = parseInt(binaryStr, 2);

                        const cell = document.createElement('div');
                        cell.className = `cell relative bg-slate-700 border border-slate-600 flex items-center justify-center text-xl md:text-2xl font-bold cursor-pointer h-16 md:h-20 select-none touch-manipulation`;
                        cell.dataset.index = index;
                        cell.onclick = () => app.toggleCellSelection(index);

                        let val = '0';
                        let colorClass = 'text-slate-500';
                        if (AppState.minterms.has(index)) {
                            val = '1';
                            colorClass = 'text-white';
                        } else if (AppState.dontCares.has(index)) {
                            val = 'X';
                            colorClass = 'text-yellow-500';
                        }

                        cell.innerHTML = `<span class="${colorClass}">${val}</span>`;

                        const label = document.createElement('div');
                        label.className = "absolute top-1 left-1 text-[8px] md:text-[10px] text-white font-bold mono opacity-90";
                        label.innerText = binaryStr;
                        cell.appendChild(label);

                        if (AppState.selectedIndices.has(index)) {
                            cell.classList.add('ring-2', 'ring-indigo-400', 'bg-slate-600');
                        }

                        root.appendChild(cell);
                    }
                }
                app.updateSelectionCount();
            },

            toggleCellSelection: (index) => {
                if (AppState.selectedIndices.has(index)) {
                    AppState.selectedIndices.delete(index);
                } else {
                    AppState.selectedIndices.add(index);
                }
                app.renderGrid();
            },

            clearSelection: () => {
                AppState.selectedIndices.clear();
                app.renderGrid();
            },

            updateSelectionCount: () => {
                const count = AppState.selectedIndices.size;
                document.getElementById('selection-count').innerText = count;
                document.getElementById('btn-add-group').disabled = count === 0;
            },

            createGroup: () => {
                const indices = Array.from(AppState.selectedIndices).sort((a, b) => a - b);

                if (!Utils.isValidGroup(indices, AppState.numVars)) {
                    app.showModal(app.t('mInvalidGroup'), app.t('mInvalidGroupMsg'), "fa-exclamation-triangle");
                    return;
                }

                for (let idx of indices) {
                    if (!AppState.minterms.has(idx) && !AppState.dontCares.has(idx)) {
                        app.showModal(app.t('mInvalidContent'), app.t('mInvalidContentMsg'), "fa-times-circle");
                        return;
                    }
                }

                const color = AppState.colors[AppState.colorIndex % AppState.colors.length];
                AppState.colorIndex++;

                AppState.userGroups.push({
                    id: Date.now(),
                    indices: indices,
                    color: color
                });

                AppState.selectedIndices.clear();
                app.renderGrid();
                app.renderGroupsList();
                app.renderGroupsOverlay();
            },

            removeGroup: (id) => {
                AppState.userGroups = AppState.userGroups.filter(g => g.id !== id);
                app.renderGroupsList();
                app.renderGroupsOverlay();
            },

            renderGroupsList: () => {
                const container = document.getElementById('groups-list');
                container.innerHTML = '';

                if (AppState.userGroups.length === 0) {
                    container.innerHTML = `<div class="text-xs md:text-sm text-slate-500 italic text-center py-4">${app.t('txtNoGroups')}</div>`;
                    return;
                }

                AppState.userGroups.forEach((g, i) => {
                    const div = document.createElement('div');
                    div.className = "flex items-center justify-between bg-slate-900 p-2 rounded border border-slate-700";
                    div.innerHTML = `
                        <div class="flex items-center">
                            <div class="w-3 h-3 rounded-full ${g.color} mr-3"></div>
                            <span class="text-sm font-mono text-slate-300">${app.t('groupLabel')} ${i + 1} (${g.indices.length} ${app.t('cells')})</span>
                        </div>
                        <button onclick="app.removeGroup(${g.id})" class="text-slate-500 hover:text-rose-500"><i class="fas fa-trash"></i></button>
                    `;
                    container.appendChild(div);
                });
            },

            renderGroupsOverlay: () => {
                const cells = document.querySelectorAll('.cell');
                cells.forEach(c => {
                    const idx = parseInt(c.dataset.index);
                    const groups = AppState.userGroups.filter(g => g.indices.includes(idx));

                    if (groups.length > 0) {
                        const colorClass = groups[groups.length - 1].color;
                        const hexMap = {
                            'bg-red-500': 'rgba(239, 68, 68, 0.4)', 'bg-blue-500': 'rgba(59, 130, 246, 0.4)',
                            'bg-green-500': 'rgba(34, 197, 94, 0.4)', 'bg-yellow-500': 'rgba(234, 179, 8, 0.4)',
                            'bg-purple-500': 'rgba(168, 85, 247, 0.4)'
                        };
                        c.style.backgroundColor = hexMap[colorClass] || 'rgba(255,255,255,0.2)';
                        c.style.borderColor = "white";
                    } else {
                        c.style.backgroundColor = "";
                        c.style.borderColor = "";
                    }
                });
            },

            /* --- VALIDATION & HINTS --- */
            toggleHint: () => {
                const covered = new Set();
                AppState.userGroups.forEach(g => g.indices.forEach(i => covered.add(i)));
                const uncovered = [...AppState.minterms].filter(m => !covered.has(m));

                if (uncovered.length > 0) {
                    const target = uncovered[0];
                    const msg = app.t('mHintMsgTarget').replace('{i}', target).replace('{b}', Utils.toBin(target, AppState.numVars));
                    app.showModal(app.t('mHintTitle'), msg, "fa-lightbulb");
                } else {
                    app.showModal(app.t('mHintTitle'), app.t('mHintMsgCovered'), "fa-check-circle");
                }
            },

            showAnswer: () => {
                const solver = new Solver(AppState.numVars, AppState.minterms, AppState.dontCares);
                const solution = solver.solve();
                AppState.userGroups = [];
                solution.forEach((sol, i) => {
                    AppState.userGroups.push({
                        id: Date.now() + i,
                        indices: sol.indices,
                        color: AppState.colors[i % AppState.colors.length]
                    });
                });

                app.renderGrid();
                app.renderGroupsList();
                app.renderGroupsOverlay();

                let eqParts = solution.map(s => Solver.binToTerm(s.bin, AppState.numVars));
                document.getElementById('equation-input').value = eqParts.join(' + ');

                app.showModal(app.t('mSolvedTitle'), app.t('mSolvedMsg'), "fa-graduation-cap");
            },

            checkSolution: () => {
                const covered = new Set();
                AppState.userGroups.forEach(g => g.indices.forEach(i => covered.add(i)));
                const missing = [...AppState.minterms].filter(m => !covered.has(m));

                if (missing.length > 0) {
                    app.showModal(app.t('mIncompleteTitle'), app.t('mIncompleteMsg'), "fa-times-circle");
                    return;
                }

                const solver = new Solver(AppState.numVars, AppState.minterms, AppState.dontCares);
                const optimalPIs = solver.solve();

                if (AppState.userGroups.length > optimalPIs.length) {
                    const msg = app.t('mNotOptimalMsg').replace('{u}', AppState.userGroups.length).replace('{o}', optimalPIs.length);
                    app.showModal(app.t('mNotOptimalTitle'), msg, "fa-compress-arrows-alt");
                    return;
                }

                app.showModal(app.t('mSuccessTitle'), app.t('mSuccessMsg'), "fa-trophy");

                if (AppState.mode === 'campaign' && AppState.stage < 3) {
                    const btn = document.getElementById('modal-btn');
                    btn.onclick = () => {
                        app.closeModal();
                        app.loadStage(AppState.stage + 1);
                    };
                    btn.innerText = app.t('btnNextStage');
                }
            },

            /* --- UTILS --- */
            showModal: (title, msg, icon) => {
                document.getElementById('modal-title').innerText = title;
                document.getElementById('modal-msg').innerText = msg;
                document.getElementById('modal-icon').innerHTML = `<i class="fas ${icon} text-indigo-400"></i>`;
                document.getElementById('modal-feedback').classList.remove('hidden');

                const btn = document.getElementById('modal-btn');
                btn.innerText = app.t('btnContinue');
                btn.onclick = app.closeModal;
            },

            closeModal: () => {
                document.getElementById('modal-feedback').classList.add('hidden');
            }
        };

        window.onload = app.init;

    </script>
</body>

</html>